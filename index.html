<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Mars Descent Controller</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />

  <!-- Sci-fi style font -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;700&display=swap" rel="stylesheet">

  <style>
    :root {
      font-family: "Orbitron", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      color-scheme: dark;
      --bg: #05070b;
      --panel: #10141f;
      --accent: #37dba5;
      --accent-soft: #37dba555;
      --danger: #ff4b6a;
      --warn: #ffb74d;
      --text: #f5f7ff;
      --muted: #9ba1bf;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      background: radial-gradient(circle at top, #1a2b3f 0, #05070b 55%);
      color: var(--text);
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: stretch;
    }

    #app {
      width: 100%;
      max-width: 480px;
      display: flex;
      flex-direction: column;
      padding: 8px;
      gap: 8px;
    }

    .card {
      background: rgba(8, 11, 20, 0.95);
      border-radius: 10px;
      border: 1px solid #1d2333;
      padding: 8px;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.6);
    }

    /* Telemetry */
    #telemetry {
      display: grid;
      grid-template-columns: 1.4fr 1.2fr 1.4fr;
      gap: 6px;
      font-size: 0.78rem;
    }
    .tele-block { display: flex; flex-direction: column; gap: 4px; }

    .tele-label {
      font-size: 0.7rem;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 0.08em;
    }

    .tele-value {
      font-size: 0.9rem;
      font-variant-numeric: tabular-nums;
    }

    .status {
      font-size: 0.75rem;
      padding: 3px 6px;
      border-radius: 12px;
      display: inline-flex;
      align-items: center;
      gap: 4px;
      background: #131a2b;
      color: var(--muted);
    }

    .status-dot {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: var(--muted);
    }

    .status-dot.entry    { background: #4fc3f7; }
    .status-dot.chute    { background: var(--warn); }
    .status-dot.powered  { background: var(--accent); }
    .status-dot.landing  { background: #e3f2fd; }
    .status-dot.crashed  { background: #ff4b6a; }

    .bar {
      height: 6px;
      background: #151b27;
      border-radius: 999px;
      overflow: hidden;
      position: relative;
    }

    .bar-fill {
      height: 100%;
      width: 0%;
      background: linear-gradient(90deg, #37dba5, #4fc3f7);
      transition: width 0.08s linear;
    }

    .bar-range-safe {
      position: absolute;
      top: 1px;
      bottom: 1px;
      background: rgba(76, 175, 80, 0.3);
      border-radius: 999px;
    }

    /* Visualisation */
    #viz-card {
      height: 32vh;
      min-height: 200px;
      display: flex;
      flex-direction: column;
    }

    #viz-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 0.75rem;
      color: var(--muted);
      margin-bottom: 4px;
    }

    #viz {
      flex: 1;
      background: radial-gradient(circle at top, #111b2e 0, #060910 55%);
      border-radius: 8px;
      border: 1px solid #1e2536;
      overflow: hidden;
      position: relative;
    }

    canvas {
      width: 100%;
      height: 100%;
      display: block;
    }

    /* Controls container */
    #controls {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .ctrl-group {
      background: var(--panel);
      border-radius: 8px;
      padding: 8px;
      border: 1px solid #1d2333;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .ctrl-label {
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--muted);
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      gap: 4px;
    }

    .btn-row {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
    }

    button {
      flex: 1;
      border-radius: 999px;
      border: 1px solid #293145;
      background: #151b27;
      color: var(--text);
      font-size: 0.78rem;
      padding: 7px 9px;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 4px;
    }

    button.primary {
      background: linear-gradient(135deg, var(--accent), #4fc3f7);
      color: #020308;
      border-color: transparent;
      font-weight: 600;
    }

    button:disabled {
      opacity: 0.45;
      cursor: default;
    }

    .mode-btn {
      flex: 1;
      font-size: 0.7rem;
      padding: 6px 4px;
    }

    .mode-btn.active {
      background: linear-gradient(135deg, var(--accent), #4fc3f7);
      color: #020308;
      border-color: transparent;
      font-weight: 600;
    }

    /* D-pad panel */
    #padPanel {
      gap: 6px;
    }

    .tilt-meter-row {
      display: flex;
      flex-direction: column;
      gap: 4px;
      margin-bottom: 4px;
    }

    .pad-row {
      display: flex;
      gap: 10px;
      align-items: center;
      justify-content: space-between;
    }

    .dpad-grid {
      display: flex;
      flex-direction: column;
      gap: 3px;
    }

    .dpad-row {
      display: flex;
      gap: 3px;
      justify-content: center;
      align-items: center;
    }

    .dpad-btn {
      width: 48px;
      height: 48px;
      border-radius: 12px;
      background: radial-gradient(circle at 30% 30%, #283347, #0b0f18);
      border: 1px solid #38445c;
      color: #e0f7fa;
      font-size: 0.95rem;
      text-shadow: 0 0 6px rgba(0, 255, 255, 0.9);
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.7);
      flex: 0 0 auto;
    }

    .dpad-center {
      width: 40px;
      height: 40px;
      border-radius: 10px;
      border: 1px dashed #283347;
      background: radial-gradient(circle at 30% 30%, #151b27, #05070b);
    }

    .dpad-btn-active,
    .dpad-btn:active {
      border-color: var(--accent);
      box-shadow: 0 0 10px var(--accent-soft);
    }

    .pad-right {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 6px;
      flex: 0 0 auto;
    }

    .chute-big {
      width: 82px;
      height: 62px;
      border-radius: 14px;
      background: radial-gradient(circle at 30% 20%, #ffeb3b, #ff5722);
      color: #1b1308;
      border: 1px solid #ffcc80;
      font-weight: 700;
      text-shadow: 0 0 6px rgba(255, 255, 255, 0.8);
      box-shadow: 0 6px 16px rgba(0, 0, 0, 0.8);
      flex: 0 0 auto;
    }

    .thrust-meter-wrapper {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
    }

    /* LED meters */
    .led-meter {
      position: relative;
      background: #020309;
      border-radius: 4px;
      border: 1px solid #283347;
      overflow: hidden;
      box-shadow: inset 0 0 8px rgba(0, 0, 0, 0.8);
    }

    .led-meter-horizontal {
      width: 100%;
      height: 16px;
    }

    .led-meter-vertical {
      width: 28px;
      height: 90px;
      display: flex;
      align-items: flex-end;
      justify-content: center;
      padding: 3px 0;
    }

    .led-fill {
      position: absolute;
      background: linear-gradient(180deg, #37dba5, #4fc3f7);
      box-shadow: 0 0 12px rgba(0, 255, 200, 0.8);
    }

    .led-meter-horizontal .led-fill {
      height: 100%;
      width: 0%;
      left: 50%;
    }

    .led-meter-vertical .led-fill {
      width: 100%;
      height: 0%;
      left: 0;
      bottom: 0;
    }

    .led-text {
      position: absolute;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.7rem;
      color: #e0f7fa;
      text-shadow: 0 0 5px rgba(0, 255, 255, 0.8);
      pointer-events: none;
    }

    .tilt-zero-mark {
      position: absolute;
      top: 0;
      bottom: 0;
      width: 1px;
      left: 50%;
      background: rgba(200, 220, 255, 0.5);
      pointer-events: none;
    }

    /* Overlay */
    #overlay {
      position: fixed;
      inset: 0;
      display: none;
      justify-content: center;
      align-items: center;
      padding: 16px;
      background: rgba(0, 0, 0, 0.7);
      z-index: 10;
    }

    #overlay-card {
      max-width: 420px;
      width: 100%;
      background: #05070b;
      border-radius: 12px;
      border: 1px solid #283347;
      padding: 14px;
    }

    #overlay-title {
      font-size: 1.1rem;
      margin-bottom: 6px;
    }

    #overlay-body {
      font-size: 0.85rem;
      color: var(--muted);
      margin-bottom: 10px;
      white-space: pre-line;
    }

    #overlay button {
      width: 100%;
    }

    /* Leaderboard list */
    .lb-list {
      margin: 4px 0 0;
      padding-left: 18px;
      font-size: 0.78rem;
      line-height: 1.35;
      white-space: normal;
    }
  </style>
</head>
<body>
  <div id="app">

    <!-- Visualisation FIRST -->
    <div id="viz-card" class="card">
      <div id="viz-header">
        <span>Side View – Exosphere to Touchdown</span>
        <span id="warningText"></span>
      </div>
      <div id="viz">
        <canvas id="vizCanvas"></canvas>
      </div>
    </div>

    <!-- Telemetry under visual -->
    <div id="telemetry" class="card">
      <div class="tele-block">
        <div>
          <div class="tele-label">Altitude</div>
          <div class="tele-value"><span id="altitude">0.0</span> km</div>
        </div>
        <div>
          <div class="tele-label">Range to Target</div>
          <div class="tele-value"><span id="range">0.0</span> km</div>
        </div>
        <div>
          <div class="tele-label">Distance to LZ</div>
          <div class="tele-value"><span id="distanceLZ">0.0</span> m</div>
        </div>
      </div>

      <div class="tele-block">
        <div>
          <div class="tele-label">Vertical Speed (m/s)</div>
          <div class="tele-value">
            <span id="vSpeed">0</span>
          </div>
        </div>
        <div>
          <div class="tele-label">Ground Speed</div>
          <div class="tele-value">
            <span id="hSpeed">0</span> m/s
          </div>
        </div>
        <div class="bar" style="margin-top:2px;">
          <div class="bar-range-safe" style="left:20%;right:60%;"></div>
          <div id="vSpeedBar" class="bar-fill"></div>
        </div>
      </div>

      <div class="tele-block">
        <div>
          <div class="tele-label">Fuel</div>
          <div class="tele-value">
            <span id="fuelPct">100</span>%
          </div>
          <div class="bar">
            <div id="fuelBar" class="bar-fill" style="width:100%;"></div>
          </div>
        </div>
        <div style="margin-top:4px;">
          <div class="tele-label">Phase</div>
          <div class="status" id="status">
            <span class="status-dot entry" id="statusDot"></span>
            <span id="statusLabel">Idle</span>
          </div>
        </div>
        <div style="margin-top:4px;">
          <div class="tele-label">Mission Time</div>
          <div class="tele-value"><span id="missionTime">0.0</span> s</div>
        </div>
      </div>
    </div>

    <!-- Controls -->
    <div id="controls">
      <!-- Start / Reset / Fullscreen -->
      <div class="ctrl-group">
        <div class="ctrl-label">
          <span>Mission Control</span>
        </div>
        <div class="btn-row">
          <button id="startBtn" class="primary">Start Mission</button>
          <button id="resetBtn">Reset</button>
          <button id="fsBtn">Fullscreen</button>
        </div>
      </div>

      <!-- D-pad + chute + LED meters -->
      <div class="ctrl-group" id="padPanel">
        <div class="tilt-meter-row">
          <div class="tele-label">Tilt</div>
          <div class="led-meter led-meter-horizontal">
            <div class="tilt-zero-mark"></div>
            <div id="tiltMeterFill" class="led-fill"></div>
            <div id="tiltMeterText" class="led-text">0°</div>
          </div>
        </div>

        <div class="pad-row">
          <div class="dpad-grid">
            <div class="dpad-row">
              <div style="width:20px;"></div>
              <button id="dpadUp" class="dpad-btn">▲</button>
              <div style="width:20px;"></div>
            </div>
            <div class="dpad-row">
              <button id="dpadLeft" class="dpad-btn">◀</button>
              <div class="dpad-center"></div>
              <button id="dpadRight" class="dpad-btn">▶</button>
            </div>
            <div class="dpad-row">
              <div style="width:20px;"></div>
              <button id="dpadDown" class="dpad-btn">▼</button>
              <div style="width:20px;"></div>
            </div>
          </div>

          <div class="pad-right">
            <button id="chuteBtn" class="chute-big">CHUTE</button>
            <div class="thrust-meter-wrapper">
              <div class="tele-label" style="text-align:center;">
                Thrust: <span id="thrustTextAbove">0%</span>
              </div>
              <div class="led-meter led-meter-vertical">
                <div id="thrustMeterFill" class="led-fill"></div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Info & Difficulty -->
      <div class="ctrl-group">
        <div class="ctrl-label">
          <span>Info & Difficulty</span>
        </div>
        <div style="font-size:0.78rem;color:var(--muted);line-height:1.3;">
          • Vertical speed: + = up, − = down.<br />
          • 10% thrust ≈ hover at initial mass.<br />
          • Chute: huge vertical drag; usable only in a mid-altitude
          “safe window”.<br />
          • Land softly and close to the flag for best scores.
        </div>
        <div class="btn-row" style="margin-top:6px;">
          <button id="modeEasy" class="mode-btn">Easy</button>
          <button id="modeMedium" class="mode-btn active">Medium</button>
          <button id="modeHard" class="mode-btn">Disaster</button>
        </div>
      </div>
    </div>

    <!-- Leaderboard -->
    <div id="leaderboardCard" class="card">
      <div class="ctrl-label">
        <span>Mission Leaderboard</span>
      </div>
      <div
        id="leaderboardContent"
        style="font-size:0.78rem;color:var(--muted);line-height:1.3;margin-top:4px;"
      >
        Loading leaderboard...
      </div>
    </div>
  </div>

  <!-- Hidden sliders used internally for values -->
  <div style="display:none;">
    <input id="thrustSlider" type="range" min="0" max="100" step="1" value="0" />
    <input id="tiltSlider" type="range" min="-25" max="25" step="1" value="0" />
  </div>

  <!-- Overlay for landing report + name entry -->
  <div id="overlay">
    <div id="overlay-card">
      <div id="overlay-title"></div>
      <div id="overlay-body"></div>
      <button id="overlay-close" class="primary">Close</button>
    </div>
  </div>

  <script>
    window.addEventListener("load", function () {
      // ---------- SUPABASE CONFIG ----------
      var SUPABASE_URL = "https://mzvggshbmlmtxxdozxab.supabase.co";
      var SUPABASE_KEY =
        "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im16dmdnc2hibWxtdHh4ZG96eGFiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUzMzExNzMsImV4cCI6MjA4MDkwNzE3M30.QUFkj9WoW_fWjFI0EDHQbOKT2EZSpVmiAC-OZuWWgxA";
      var SUPABASE_TABLE = "scores";

      // ---------- DOM REFS ----------
      var altitudeEl   = document.getElementById("altitude");
      var rangeEl      = document.getElementById("range");
      var distanceLZEl = document.getElementById("distanceLZ");
      var vSpeedEl     = document.getElementById("vSpeed");
      var hSpeedEl     = document.getElementById("hSpeed");
      var vSpeedBarEl  = document.getElementById("vSpeedBar");
      var fuelPctEl    = document.getElementById("fuelPct");
      var fuelBarEl    = document.getElementById("fuelBar");
      var statusLabelEl= document.getElementById("statusLabel");
      var statusDotEl  = document.getElementById("statusDot");
      var missionTimeEl= document.getElementById("missionTime");
      var warningTextEl= document.getElementById("warningText");

      var startBtn     = document.getElementById("startBtn");
      var resetBtn     = document.getElementById("resetBtn");
      var fsBtn        = document.getElementById("fsBtn");
      var chuteBtn     = document.getElementById("chuteBtn");

      var modeEasyBtn   = document.getElementById("modeEasy");
      var modeMediumBtn = document.getElementById("modeMedium");
      var modeHardBtn   = document.getElementById("modeHard");

      var leaderboardContent = document.getElementById("leaderboardContent");

      var canvas = document.getElementById("vizCanvas");
      var ctx    = canvas.getContext("2d");

      var overlay      = document.getElementById("overlay");
      var overlayTitle = document.getElementById("overlay-title");
      var overlayBody  = document.getElementById("overlay-body");
      var overlayClose = document.getElementById("overlay-close");

      var thrustSlider     = document.getElementById("thrustSlider");
      var tiltSlider       = document.getElementById("tiltSlider");
      var thrustMeterFill  = document.getElementById("thrustMeterFill");
      var thrustTextAbove  = document.getElementById("thrustTextAbove");
      var tiltMeterFill    = document.getElementById("tiltMeterFill");
      var tiltMeterText    = document.getElementById("tiltMeterText");

      var dpadUp    = document.getElementById("dpadUp");
      var dpadDown  = document.getElementById("dpadDown");
      var dpadLeft  = document.getElementById("dpadLeft");
      var dpadRight = document.getElementById("dpadRight");

      // ---------- LEADERBOARD HELPERS ----------
      function difficultyLabel(mode) {
        if (mode === "easy")   return "Easy";
        if (mode === "medium") return "Medium";
        if (mode === "hard")   return "Disaster Waiting to Happen";
        return mode;
      }

      function renderLeaderboard(list) {
        if (!list || list.length === 0) {
          leaderboardContent.textContent = "No successful landings yet.";
          return;
        }
        var html = '<ol class="lb-list">';
        for (var i = 0; i < list.length; i++) {
          var e = list[i];
          html += '<li><strong>' + e.name + '</strong> – ' + e.score + ' pts<br>' +
                  '<span style="font-size:0.75rem;color:var(--muted);">' +
                  difficultyLabel(e.mode) + ", " +
                  e.distanceKm + " km, " +
                  e.timeSec + " s, " +
                  e.fuelUsedPct + "% fuel</span></li>';
        }
        html += "</ol>";
        leaderboardContent.innerHTML = html;
      }

      function fetchLeaderboard(limit) {
        if (typeof limit === "undefined") limit = 10;
        leaderboardContent.textContent = "Loading leaderboard...";
        return fetch(
          SUPABASE_URL + "/rest/v1/" + SUPABASE_TABLE +
          "?select=*&order=score.desc&limit=" + limit,
          {
            headers: {
              apikey: SUPABASE_KEY,
              Authorization: "Bearer " + SUPABASE_KEY
            }
          }
        )
          .then(function (res) {
            if (!res.ok) {
              console.warn("Leaderboard fetch not ok:", res.status);
              return [];
            }
            return res.json();
          })
          .then(function (rows) {
            var list = [];
            for (var i = 0; i < rows.length; i++) {
              var r = rows[i];
              list.push({
                name: r.name,
                score: r.score,
                distanceKm: Number(r.distance_km || 0).toFixed(3),
                timeSec: Number(r.time_sec   || 0).toFixed(1),
                fuelUsedPct: Number(r.fuel_used_pct || 0).toFixed(0),
                mode: r.mode || "unknown"
              });
            }
            renderLeaderboard(list);
          })
          .catch(function (err) {
            console.error("Failed to fetch leaderboard:", err);
            leaderboardContent.textContent = "Leaderboard unavailable.";
          });
      }

      function submitScore(entry) {
        return fetch(SUPABASE_URL + "/rest/v1/" + SUPABASE_TABLE, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            apikey: SUPABASE_KEY,
            Authorization: "Bearer " + SUPABASE_KEY,
            Prefer: "return=minimal"
          },
          body: JSON.stringify({
            name: entry.name,
            score: entry.score,
            distance_km: entry.distanceKm,
            time_sec: entry.timeSec,
            fuel_used_pct: entry.fuelUsedPct,
            mode: entry.mode
          })
        }).catch(function (err) {
          console.error("Failed to submit score:", err);
        });
      }

      // ---------- CANVAS RESIZE ----------
      function resizeCanvas() {
        var rect = canvas.getBoundingClientRect();
        var dpr = window.devicePixelRatio || 1;
        canvas.width  = rect.width  * dpr;
        canvas.height = rect.height * dpr;
        ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
        initStars();
      }
      window.addEventListener("resize", resizeCanvas);
      resizeCanvas();

      // ---------- PHYSICS CONSTANTS ----------
      var G = 7.5;
      var DRY_MASS        = 900;
      var FUEL_MAX        = 120;
      var FUEL_BURN_RATE  = 0.8;
      var FUEL_UNIT_MASS  = 4;

      var THRUST_ACCEL_FACTOR      = 10 * G;
      var HORIZONTAL_THRUST_FACTOR = 2.3;

      var RHO0         = 0.005;
      var SCALE_HEIGHT = 8000;

      var MAX_SIM_ALT        = 2000;
      var STAR_ALT_THRESHOLD = 2000;

      var ROUND_TIME_LIMIT   = 300;

      var difficultyPresets = {
        easy:   { safeV: 40, crashV: 60 },
        medium: { safeV: 20, crashV: 40 },
        hard:   { safeV: 3,  crashV: 6  }
      };

      var difficulty = "medium";

      function setDifficulty(mode) {
        difficulty = mode;
        modeEasyBtn.classList.toggle("active",   mode === "easy");
        modeMediumBtn.classList.toggle("active", mode === "medium");
        modeHardBtn.classList.toggle("active",   mode === "hard");
      }

      // ---------- STARFIELD ----------
      var stars      = [];
      var starScrollX = 0;
      var starScrollY = 0;

      function initStars() {
        var w = canvas.width / (window.devicePixelRatio || 1);
        var h = canvas.height / (window.devicePixelRatio || 1);
        stars = [];
        var count = 80;
        for (var i = 0; i < count; i++) {
          stars.push({
            x: Math.random() * w,
            y: Math.random() * h,
            depth: 0.4 + Math.random() * 1.1
          });
        }
      }

      function updateStars(dt) {
        if (!state) return;
        // Move stars opposite velocity vector so they look like wallpaper you’re flying past
        var factor = 0.8; // bumped up for stronger speed sense
        starScrollX += -state.vx * dt * factor;
        starScrollY += -state.vy * dt * factor;
      }

      function renderStars() {
        var w = canvas.width / (window.devicePixelRatio || 1);
        var h = canvas.height / (window.devicePixelRatio || 1);
        ctx.save();
        ctx.fillStyle = "#02030a";
        ctx.fillRect(0, 0, w, h);

        for (var i = 0; i < stars.length; i++) {
          var s = stars[i];
          var x = (s.x + starScrollX * s.depth) % w;
          var y = (s.y + starScrollY * s.depth) % h;
          if (x < 0) x += w;
          if (y < 0) y += h;

          var size  = 1 + s.depth * 1.5;
          var alpha = 0.3 + 0.6 * s.depth;
          ctx.fillStyle = "rgba(220,235,255," + alpha.toFixed(2) + ")";
          ctx.fillRect(x, y, size, size);
        }

        ctx.restore();
      }

      // ---------- STATE ----------
      var state = null;
      var lastScoreData = null;

      function clamp(v, min, max) {
        return v < min ? min : (v > max ? max : v);
      }

      function createInitialState() {
        var baseVx = 50;
        var variability = 0.15;
        var factor = 1 + (Math.random() * 2 - 1) * variability;
        var dir    = Math.random() < 0.5 ? -1 : 1;
        var initialVx = dir * baseVx * factor;

        return {
          x: -900,
          y: 1700,
          vx: initialVx,
          vy: -85,
          thetaDeg: 0,
          fuel: FUEL_MAX,
          chuteDeployed: false,
          chuteSafe: false,
          time: 0,
          playing: false,
          finished: false,
          crashed: false,
          predictedImpactX: null,
          phase: "IDLE"
        };
      }

      function resetGame() {
        state = createInitialState();
        thrustSlider.value = "0";
        tiltSlider.value   = "0";

        startBtn.disabled = false;
        startBtn.textContent = "Start Mission";
        chuteBtn.disabled = true;
        warningTextEl.textContent = "";

        celebrateTime = 0;
        meteors = [];
        starScrollX = 0;
        starScrollY = 0;
        hideOverlay();
      }

      setDifficulty("medium");
      resetGame();
      fetchLeaderboard(10);

      function computeDensity(alt) {
        if (alt <= 0) return 0;
        return RHO0 * Math.exp(-alt / SCALE_HEIGHT);
      }

      function updatePhaseLabels() {
        var phaseLabel = "Idle";
        var dotClass   = "entry";

        if (!state.playing && !state.finished && state.time === 0) {
          phaseLabel = "Ready";
        } else if (!state.playing && !state.finished && state.time > 0) {
          phaseLabel = "Paused";
        } else if (state.finished && state.crashed) {
          phaseLabel = "Crash";
          dotClass   = "crashed";
        } else if (state.finished && !state.crashed) {
          phaseLabel = "Touchdown";
          dotClass   = "landing";
        } else {
          var alt = state.y;
          if (alt > 1200) {
            phaseLabel = "Entry";
            dotClass   = "entry";
          } else if (state.chuteDeployed) {
            phaseLabel = "Chute";
            dotClass   = "chute";
          } else if (alt > 400) {
            phaseLabel = "Powered Descent";
            dotClass   = "powered";
          } else {
            phaseLabel = "Landing";
            dotClass   = "landing";
          }
        }

        state.phase = phaseLabel;
        statusLabelEl.textContent = phaseLabel;
        statusDotEl.className = "status-dot " + dotClass;
      }

      function step(dt) {
        if (!state.playing || state.finished) return;

        state.time += dt;

        var throttlePct = parseFloat(thrustSlider.value);
        var throttle    = throttlePct / 100;
        var tiltDeg     = parseFloat(tiltSlider.value);
        state.thetaDeg  = tiltDeg;

        var alt      = state.y;
        var vDownMag = Math.max(0, -state.vy);

        state.chuteSafe = alt > 900 && alt < 1800 && vDownMag > 20 && vDownMag < 200;

        var mass = DRY_MASS + state.fuel * FUEL_UNIT_MASS;

        var thetaRad = state.thetaDeg * Math.PI / 180;
        var rho      = computeDensity(alt);
        var CdA      = 2.0;

        var a_drag_x = 0;
        var a_drag_y = 0;
        if (mass > 0) {
          a_drag_x = (-0.5 * rho * CdA * state.vx * Math.abs(state.vx)) / mass;
          a_drag_y = (-0.5 * rho * CdA * state.vy * Math.abs(state.vy)) / mass;
        }

        if (state.chuteDeployed && mass > 0) {
          var chuteCdA = 18;
          a_drag_y += (-0.5 * rho * chuteCdA * state.vy * Math.abs(state.vy)) / mass;
        }

        var a_thrust_y = THRUST_ACCEL_FACTOR * throttle * Math.cos(thetaRad);
        var a_thrust_x = -THRUST_ACCEL_FACTOR * throttle * Math.sin(thetaRad) * HORIZONTAL_THRUST_FACTOR;

        var a_grav_y = -G;

        var ax = a_thrust_x + a_drag_x;
        var ay = a_thrust_y + a_drag_y + a_grav_y;

        state.vx += ax * dt;
        state.vy += ay * dt;

        state.vx = clamp(state.vx, -250, 250);
        state.vy = clamp(state.vy, -250, 80);

        state.x += state.vx * dt;
        state.y += state.vy * dt;

        state.fuel -= FUEL_BURN_RATE * throttle * dt;
        if (state.fuel < 0) state.fuel = 0;

        if (state.fuel <= 0 && thrustSlider.value !== "0") {
          thrustSlider.value = "0";
        }

        if (state.time > ROUND_TIME_LIMIT && !state.finished) {
          finishLanding(true);
        }

        if (state.y <= 0 && !state.finished) {
          state.y = 0;
          finishLanding(false);
        }
      }

      function showOverlay(title, body) {
        overlayTitle.textContent = title;
        overlayBody.textContent  = body;
        overlay.style.display = "flex";
      }

      function hideOverlay() {
        overlay.style.display = "none";
      }

      overlayClose.addEventListener("click", hideOverlay);
      overlay.addEventListener("click", function (e) {
        if (e.target === overlay) hideOverlay();
      });

      function finishLanding(timeOut) {
        state.finished = true;
        state.playing  = false;

        var vy = state.vy;
        var vx = state.vx;
        var range = Math.abs(state.x);
        var fuelPctRemaining = (state.fuel / FUEL_MAX) * 100;
        var fuelUsedPct      = clamp(100 - fuelPctRemaining, 0, 100);

        var crashV = difficultyPresets[difficulty].crashV;

        var crashed = timeOut;
        var cause   = timeOut ? "MISSION TIME EXPIRED" : "";

        if (!timeOut) {
          if (Math.abs(vy) > crashV) {
            crashed = true;
            cause = "Impact too hard vertically (>" + crashV + " m/s)";
          } else if (Math.abs(vx) > crashV) {
            crashed = true;
            cause = "Too much ground speed (>" + crashV + " m/s)";
          }
        }

        state.crashed = crashed;

        var distanceKm = range / 1000;
        var timeSec    = state.time;

        if (crashed) {
          var reportLines = [];
          reportLines.push("Vertical speed: " + vy.toFixed(1) + " m/s ( + = up, − = down )");
          reportLines.push("Ground speed: "   + vx.toFixed(1) + " m/s");
          reportLines.push("Distance from target: " + distanceKm.toFixed(3) + " km");
          reportLines.push("Fuel remaining: " + fuelPctRemaining.toFixed(0) + "%");
          reportLines.push("");
          reportLines.push(cause);
          reportLines.push("");
          reportLines.push("Score: 0");

          showOverlay("MISSION FAILURE", reportLines.join("\n"));
          startBtn.disabled = true;
          chuteBtn.disabled = true;
          startBtn.textContent = "Start Mission";
          return;
        }

        var base            = 1000;
        var distancePenalty = clamp(distanceKm * 400, 0, 600);
        var timePenalty     = clamp((timeSec - 10) * 8, 0, 400);
        var fuelPenalty     = clamp(fuelUsedPct * 1.5, 0, 300);

        var score = Math.round(base - distancePenalty - timePenalty - fuelPenalty);
        if (score < 0) score = 0;

        var title;
        if (score > 900)      title = "PERFECT TOUCHDOWN";
        else if (score > 700) title = "NOMINAL LANDING";
        else if (score > 450) title = "MARGINAL LANDING";
        else                  title = "BARELY WALKING AWAY";

        lastScoreData = {
          score: score,
          distanceKm: distanceKm.toFixed(3),
          timeSec: timeSec.toFixed(1),
          fuelUsedPct: fuelUsedPct.toFixed(0),
          mode: difficulty
        };

        celebrateTime = 10;
        meteors = [];

        overlayTitle.textContent = title;
        overlayBody.innerHTML =
          '<div style="margin-bottom:8px;">' +
          '<div>Score: <strong>' + score + "</strong></div>" +
          "<div>Distance from pin: " + lastScoreData.distanceKm + " km</div>" +
          "<div>Mission time: " + lastScoreData.timeSec + " s</div>" +
          "<div>Fuel used: " + lastScoreData.fuelUsedPct + "%</div>" +
          "<div>Mode: " + difficultyLabel(lastScoreData.mode) + "</div>" +
          "</div>" +
          '<div style="margin-top:4px;">' +
          '<label for="nameInput" style="font-size:0.8rem;display:block;margin-bottom:4px;">Commander name</label>' +
          '<input id="nameInput" type="text" maxlength="20" placeholder="Type your name" ' +
          'style="width:100%;padding:4px 6px;border-radius:4px;border:1px solid #293145;background:#05070b;color:#f5f7ff;font-size:0.85rem;" />' +
          '<button id="saveScoreBtn" class="primary" style="margin-top:6px;width:100%;">Save to Leaderboard</button>' +
          "</div>";

        overlay.style.display = "flex";

        var saveBtn   = document.getElementById("saveScoreBtn");
        var nameInput = document.getElementById("nameInput");
        if (saveBtn && nameInput) {
          saveBtn.addEventListener("click", function () {
            var name = nameInput.value.trim() || "Anonymous";
            var data = lastScoreData;
            submitScore({
              name: name,
              score: data.score,
              distanceKm: data.distanceKm,
              timeSec: data.timeSec,
              fuelUsedPct: data.fuelUsedPct,
              mode: data.mode
            }).then(function () {
              return fetchLeaderboard(10);
            }).finally(function () {
              hideOverlay();
            });
          });
        }

        startBtn.disabled = true;
        startBtn.textContent = "Start Mission";
        chuteBtn.disabled = true;
      }

      function predictImpact() {
        var x = state.x;
        var y = state.y;
        var vx = state.vx;
        var vy = state.vy;
        var chute = state.chuteDeployed;
        var t = 0;
        var dt = 0.1;
        var maxT = 120;

        while (y > 0 && t < maxT) {
          var rho = computeDensity(y);
          var CdA = 2.0;
          var mass = DRY_MASS + state.fuel * FUEL_UNIT_MASS;

          var a_drag_x = 0;
          var a_drag_y = 0;
          if (mass > 0) {
            a_drag_x = (-0.5 * rho * CdA * vx * Math.abs(vx)) / mass;
            a_drag_y = (-0.5 * rho * CdA * vy * Math.abs(vy)) / mass;
          }
          if (chute && mass > 0) {
            var chuteCdA = 18;
            a_drag_y += (-0.5 * rho * chuteCdA * vy * Math.abs(vy)) / mass;
          }
          var a_grav_y = -G;

          vx += a_drag_x * dt;
          vy += (a_drag_y + a_grav_y) * dt;
          x  += vx * dt;
          y  += vy * dt;
          t  += dt;
        }
        state.predictedImpactX = x;
      }

      // Meteor shower FX
      var celebrateTime = 0;
      var meteors = [];

      function updateMeteors(dt) {
        var w = canvas.width / (window.devicePixelRatio || 1);
        var h = canvas.height / (window.devicePixelRatio || 1);

        if (celebrateTime > 0) {
          celebrateTime -= dt;
          if (celebrateTime < 0) celebrateTime = 0;
          for (var i = 0; i < 4; i++) {
            meteors.push({
              x: Math.random() * w,
              y: Math.random() * (h * 0.4),
              vx: 180 + Math.random() * 120,
              vy: 180 + Math.random() * 120,
              life: 0,
              maxLife: 0.8 + Math.random() * 0.6
            });
          }
        }

        var next = [];
        for (var j = 0; j < meteors.length; j++) {
          var m = meteors[j];
          m.x   -= m.vx * dt;
          m.y   += m.vy * dt;
          m.life += dt;
          if (m.life < m.maxLife) next.push(m);
        }
        meteors = next;
      }

      function renderMeteors() {
        if (celebrateTime <= 0 || meteors.length === 0) return;
        ctx.save();
        ctx.globalAlpha = 0.9;
        ctx.lineWidth   = 2;
        for (var i = 0; i < meteors.length; i++) {
          var m = meteors[i];
          var trailX = m.x + m.vx * 0.05;
          var trailY = m.y - m.vy * 0.05;
          var tNorm = clamp(m.life / m.maxLife, 0, 1);
          var r = 255;
          var gCol = Math.round(200 + 55 * (1 - tNorm));
          var bCol = Math.round(120 * (1 - tNorm));
          ctx.strokeStyle = "rgba(" + r + "," + gCol + "," + bCol + "," + (1 - tNorm * 0.7) + ")";
          ctx.beginPath();
          ctx.moveTo(m.x, m.y);
          ctx.lineTo(trailX, trailY);
          ctx.stroke();
        }
        ctx.restore();
      }

      function render() {
        updatePhaseLabels();

        altitudeEl.textContent   = (state.y / 1000).toFixed(3);
        rangeEl.textContent      = (Math.abs(state.x) / 1000).toFixed(3);
        distanceLZEl.textContent = Math.abs(state.x).toFixed(1);

        vSpeedEl.textContent     = state.vy.toFixed(1);
        hSpeedEl.textContent     = state.vx.toFixed(1);
        missionTimeEl.textContent= state.time.toFixed(1);

        var fuelPct = (state.fuel / FUEL_MAX) * 100;
        fuelPctEl.textContent     = fuelPct.toFixed(0);
        fuelBarEl.style.width     = clamp(fuelPct, 0, 100) + "%";

        var vDown  = Math.max(0, -state.vy);
        var vNorm  = clamp(vDown / 50, 0, 1);
        vSpeedBarEl.style.width = (vNorm * 100).toFixed(0) + "%";

        var crashV = difficultyPresets[difficulty].crashV;

        if (vDown > crashV && state.y < 600 && !state.finished) {
          warningTextEl.textContent = "⚠ TOO FAST";
        } else if (state.fuel <= 0 && state.y > 0 && !state.finished) {
          warningTextEl.textContent = "⚠ FUEL DEPLETED";
        } else if (state.chuteSafe && !state.chuteDeployed && !state.finished) {
          warningTextEl.textContent = "CHUTE AVAILABLE";
        } else {
          warningTextEl.textContent = "";
        }

        var throttlePct = parseFloat(thrustSlider.value);
        var tiltDeg     = parseFloat(tiltSlider.value);

        // Thrust meter
        var thrFrac = clamp(throttlePct / 100, 0, 1);
        thrustMeterFill.style.height = (thrFrac * 100).toFixed(0) + "%";
        thrustTextAbove.textContent  = throttlePct.toFixed(0) + "%";
        var thrColor;
        if (thrFrac < 0.7)      thrColor = "rgba(55,219,165,0.95)";
        else if (thrFrac < 0.9) thrColor = "rgba(255,183,77,0.98)";
        else                    thrColor = "rgba(255,75,106,0.98)";
        thrustMeterFill.style.background = thrColor;
        thrustMeterFill.style.boxShadow  = "0 0 12px " + thrColor;

        // Tilt meter (centre zero)
        var tiltFrac   = clamp(Math.abs(tiltDeg) / 25, 0, 1);
        var half       = 50;
        var widthPct   = tiltFrac * half;
        if (tiltDeg >= 0) {
          tiltMeterFill.style.left = "50%";
        } else {
          tiltMeterFill.style.left = (50 - widthPct) + "%";
        }
        tiltMeterFill.style.width     = widthPct + "%";
        var tiltColor;
        if (tiltFrac < 0.7)      tiltColor = "rgba(55,219,165,0.95)";
        else if (tiltFrac < 0.9) tiltColor = "rgba(255,183,77,0.98)";
        else                     tiltColor = "rgba(255,75,106,0.98)";
        tiltMeterFill.style.background = tiltColor;
        tiltMeterFill.style.boxShadow  = "0 0 12px " + tiltColor;
        tiltMeterText.textContent      = tiltDeg.toFixed(0) + "°";

        if (!state.finished && state.y > 0) {
          predictImpact();
        }

        var dpr = window.devicePixelRatio || 1;
        var w   = canvas.width  / dpr;
        var h   = canvas.height / dpr;

        ctx.clearRect(0, 0, w, h);

        var inSpace = state.y > STAR_ALT_THRESHOLD;
        var groundY = h - 26;
        var targetXScreen = w * 0.5;
        var scaleX        = 0.04;

        if (inSpace) {
          renderStars();
        } else {
          // Atmosphere layers
          var layers = [
            "rgba(90,140,255,0.08)",
            "rgba(120,110,255,0.08)",
            "rgba(180,90,200,0.08)",
            "rgba(255,150,120,0.10)"
          ];
          var layerCount = layers.length;
          for (var i = 0; i < layerCount; i++) {
            var y0 = groundY * i / layerCount;
            var y1 = groundY * (i + 1) / layerCount;
            ctx.fillStyle = layers[i];
            ctx.fillRect(0, y0, w, y1 - y0);
          }

          ctx.fillStyle = "#151515";
          ctx.fillRect(0, groundY, w, h - groundY);

          ctx.save();
          ctx.translate(targetXScreen, groundY);
          ctx.strokeStyle = "#ffffff";
          ctx.lineWidth   = 2;
          ctx.beginPath();
          ctx.moveTo(0, 0);
          ctx.lineTo(0, -18);
          ctx.stroke();

          ctx.fillStyle = "#ffeb3b";
          ctx.beginPath();
          ctx.moveTo(0, -18);
          ctx.lineTo(14, -14);
          ctx.lineTo(0, -10);
          ctx.closePath();
          ctx.fill();
          ctx.restore();
        }

        renderMeteors();

        // Lander screen coords
        var landerXScreen;
        var landerYScreen;

        if (inSpace) {
          // keep ship centred horizontally in space
          landerXScreen = w * 0.5;
          var spaceTop    = 40;
          var spaceBottom = h * 0.7;
          var extraAlt    = state.y - STAR_ALT_THRESHOLD;
          var norm        = clamp(extraAlt / STAR_ALT_THRESHOLD, 0, 1);
          landerYScreen   = spaceBottom - norm * (spaceBottom - spaceTop);
        } else {
          landerXScreen = targetXScreen + state.x * scaleX;
          var altNorm     = clamp(state.y / MAX_SIM_ALT, 0, 1);
          landerYScreen   = groundY - 10 - altNorm * (groundY - 40);
        }

        // predicted impact ✕
        if (!inSpace && state.predictedImpactX !== null && state.y > 0 && !state.finished) {
          var impactScreenX = targetXScreen + state.predictedImpactX * scaleX;
          var clampedImpactX = clamp(impactScreenX, 0, w);
          ctx.save();
          ctx.translate(clampedImpactX, groundY);
          ctx.strokeStyle = "#ff8a65";
          ctx.lineWidth   = 2;
          ctx.beginPath();
          ctx.moveTo(-8, 0);
          ctx.lineTo(8, 0);
          ctx.moveTo(0, 0);
          ctx.lineTo(0, -10);
          ctx.stroke();
          ctx.fillStyle  = "#ff8a65";
          ctx.font       = "10px system-ui";
          ctx.textAlign  = "center";
          ctx.fillText("✕", 0, -12);
          ctx.restore();
        }

        // helper vertical from ship to ground (when atmosphere visible)
        if (!inSpace) {
          ctx.save();
          ctx.strokeStyle = "rgba(55,219,165,0.4)";
          ctx.lineWidth   = 1;
          ctx.beginPath();
          ctx.moveTo(landerXScreen, groundY - 10);
          ctx.lineTo(landerXScreen, landerYScreen);
          ctx.stroke();
          ctx.restore();
        }

        // Off-screen direction arrows: show how to get back over the LZ (pin at x=0)
        var worldToScreen = Math.abs(state.x) * scaleX;
        if (worldToScreen > w * 0.5) {
          ctx.save();
          ctx.fillStyle = "#ffeb3b";
          ctx.font = "14px system-ui";

          if (state.x > 0) {
            // Ship is to the RIGHT of the LZ -> point LEFT to get back
            ctx.textAlign = "right";
            ctx.fillText("◀", w - 6, h - 6);
          } else {
            // Ship is to the LEFT of the LZ -> point RIGHT to get back
            ctx.textAlign = "left";
            ctx.fillText("▶", 6, h - 6);
          }
          ctx.restore();
        }

        if (state.finished && state.crashed) {
          var crashGroundY = inSpace ? (h - 26) : groundY;
          ctx.save();
          ctx.translate(landerXScreen, crashGroundY - 4);

          ctx.fillStyle = "#3e2723";
          ctx.beginPath();
          ctx.ellipse(0, 6, 14, 5, 0, 0, Math.PI * 2);
          ctx.fill();

          var grad = ctx.createRadialGradient(0, -4, 0, 0, -4, 20);
          grad.addColorStop(0,   "rgba(255, 234, 0, 0.9)");
          grad.addColorStop(0.4, "rgba(255, 160, 0, 0.7)");
          grad.addColorStop(1,   "rgba(121, 85, 72, 0)");
          ctx.fillStyle = grad;
          ctx.beginPath();
          ctx.arc(0, -4, 20, 0, Math.PI * 2);
          ctx.fill();

          ctx.fillStyle = "#ffc107";
          for (var k = 0; k < 8; k++) {
            var angle = Math.PI * 2 * k / 8;
            var dx = Math.cos(angle) * (8 + k);
            var dy = Math.sin(angle) * (5 + k * 0.5);
            ctx.beginPath();
            ctx.arc(dx, -4 + dy, 1.5, 0, Math.PI * 2);
            ctx.fill();
          }
          ctx.restore();
          return;
        }

        // Normal lander
        ctx.save();
        ctx.translate(landerXScreen, landerYScreen);

        var tiltRad = state.thetaDeg * Math.PI / 180;
        ctx.rotate(-tiltRad);

        ctx.fillStyle   = "#eceff1";
        ctx.strokeStyle = "#263238";
        ctx.lineWidth   = 1.5;
        ctx.beginPath();
        ctx.moveTo(-6, 8);
        ctx.lineTo(6, 8);
        ctx.lineTo(10, -4);
        ctx.lineTo(0, -14);
        ctx.lineTo(-10, -4);
        ctx.closePath();
        ctx.fill();
        ctx.stroke();

        ctx.fillStyle = "#4fc3f7";
        ctx.beginPath();
        ctx.arc(0, -7, 3, 0, Math.PI * 2);
        ctx.fill();

        ctx.strokeStyle = "#90a4ae";
        ctx.lineWidth   = 1.3;
        ctx.beginPath();
        ctx.moveTo(-6, 8);
        ctx.lineTo(-10, 14);
        ctx.moveTo(6, 8);
        ctx.lineTo(10, 14);
        ctx.stroke();

        var throttle = throttlePct / 100;
        if (throttle > 0.02 && !state.finished) {
          var flameLen = 4 + 22 * throttle;
          ctx.fillStyle = "#ffb74d";
          ctx.beginPath();
          ctx.moveTo(-3, 8);
          ctx.lineTo(3, 8);
          ctx.lineTo(0, 8 + flameLen);
          ctx.closePath();
          ctx.fill();

          ctx.fillStyle = "#ff9800";
          ctx.beginPath();
          ctx.moveTo(-1.5, 8);
          ctx.lineTo(1.5, 8);
          ctx.lineTo(0, 8 + flameLen * 0.7);
          ctx.closePath();
          ctx.fill();
        }

        if (state.chuteDeployed && state.y > 200) {
          ctx.save();
          ctx.translate(0, -18);
          ctx.strokeStyle = "#cfd8dc";
          ctx.lineWidth   = 1;
          ctx.beginPath();
          ctx.moveTo(0, 0);
          ctx.lineTo(0, -12);
          ctx.stroke();

          ctx.fillStyle = "#ffcc80";
          ctx.beginPath();
          ctx.arc(0, -16, 7, Math.PI, 0);
          ctx.fill();
          ctx.restore();
        }

        ctx.restore();
      }

      // ---------- FULLSCREEN ----------
      function isFullscreen() {
        return document.fullscreenElement ||
               document.webkitFullscreenElement ||
               document.mozFullScreenElement ||
               document.msFullscreenElement;
      }

      function requestFullscreen(elem) {
        if (elem.requestFullscreen)       elem.requestFullscreen();
        else if (elem.webkitRequestFullscreen) elem.webkitRequestFullscreen();
        else if (elem.mozRequestFullScreen)    elem.mozRequestFullScreen();
        else if (elem.msRequestFullscreen)     elem.msRequestFullscreen();
      }

      function exitFullscreen() {
        if (document.exitFullscreen)       document.exitFullscreen();
        else if (document.webkitExitFullscreen) document.webkitExitFullscreen();
        else if (document.mozCancelFullScreen)  document.mozCancelFullScreen();
        else if (document.msExitFullscreen)     document.msExitFullscreen();
      }

      function updateFsButtonLabel() {
        fsBtn.textContent = isFullscreen() ? "Windowed" : "Fullscreen";
      }

      fsBtn.addEventListener("click", function () {
        if (isFullscreen()) exitFullscreen();
        else requestFullscreen(document.documentElement);
      });

      document.addEventListener("fullscreenchange",       updateFsButtonLabel);
      document.addEventListener("webkitfullscreenchange", updateFsButtonLabel);
      document.addEventListener("mozfullscreenchange",    updateFsButtonLabel);
      document.addEventListener("MSFullscreenChange",     updateFsButtonLabel);
      updateFsButtonLabel();

      // ---------- D-PAD / TOUCH STATES ----------
      function bindPadButton(btn, stateObj) {
        function setDown(e) {
          e.preventDefault();
          stateObj.touch = true;
          btn.classList.add("dpad-btn-active");
        }
        function setUp(e) {
          e.preventDefault();
          stateObj.touch = false;
          btn.classList.remove("dpad-btn-active");
        }
        ["mousedown", "touchstart"].forEach(function (ev) {
          btn.addEventListener(ev, setDown);
        });
        ["mouseup", "mouseleave", "touchend", "touchcancel"].forEach(function (ev) {
          btn.addEventListener(ev, setUp);
        });
      }

      var thrustUpState   = { touch: false, prev: false, hold: 0 };
      var thrustDownState = { touch: false, prev: false, hold: 0 };
      var tiltLeftState   = { touch: false, prev: false, hold: 0 };
      var tiltRightState  = { touch: false, prev: false, hold: 0 };

      bindPadButton(dpadUp,    thrustUpState);
      bindPadButton(dpadDown,  thrustDownState);
      bindPadButton(dpadLeft,  tiltLeftState);
      bindPadButton(dpadRight, tiltRightState);

      function handleLogarithmicControl(dt, stateObj, slider, isThrust, sign) {
        var isPressed = stateObj.touch;
        if (!isPressed) {
          stateObj.prev = false;
          stateObj.hold = 0;
          return;
        }

        if (!stateObj.prev) {
          var v = parseFloat(slider.value);
          v += sign * 1;
          v = clamp(v, parseFloat(slider.min), parseFloat(slider.max));
          slider.value = String(Math.round(v));
          stateObj.prev = true;
          stateObj.hold = 0;
          return;
        }

        stateObj.hold += dt;
        var hold = stateObj.hold;
        var threshold = 0.2;
        if (hold <= threshold) return;
        var t   = hold - threshold;
        var base = isThrust ? 35 : 18;
        var speed = base * Math.log(1 + t * 4) / Math.log(2);

        var val = parseFloat(slider.value);
        val += sign * speed * dt;
        val = clamp(val, parseFloat(slider.min), parseFloat(slider.max));
        slider.value = String(Math.round(val));
      }

      function updateControlRamps(dt) {
        handleLogarithmicControl(dt, thrustUpState,   thrustSlider, true,  +1);
        handleLogarithmicControl(dt, thrustDownState, thrustSlider, true,  -1);
        handleLogarithmicControl(dt, tiltLeftState,   tiltSlider,   false, -1);
        handleLogarithmicControl(dt, tiltRightState,  tiltSlider,   false, +1);
      }

      // ---------- BUTTON HANDLERS ----------
      startBtn.addEventListener("click", function () {
        if (state.finished) return;
        if (state.playing) {
          state.playing = false;
          startBtn.textContent = "Resume";
        } else {
          state.playing = true;
          startBtn.textContent = "Pause";
          chuteBtn.disabled = false;
        }
      });

      resetBtn.addEventListener("click", function () {
        resetGame();
      });

      chuteBtn.addEventListener("click", function () {
        if (!state.chuteDeployed && state.chuteSafe && !state.finished) {
          state.chuteDeployed = true;
          chuteBtn.disabled = true;
        }
      });

      modeEasyBtn.addEventListener("click",   function () { setDifficulty("easy");   });
      modeMediumBtn.addEventListener("click", function () { setDifficulty("medium"); });
      modeHardBtn.addEventListener("click",   function () { setDifficulty("hard");   });

      // ---------- MAIN LOOP ----------
      var lastTs = null;

      function loop(timestamp) {
        if (lastTs === null) lastTs = timestamp;
        var dt = (timestamp - lastTs) / 1000;
        lastTs = timestamp;

        var stepSize = 1 / 60;
        var acc = dt;
        while (acc > 0) {
          var d = acc < stepSize ? acc : stepSize;
          step(d);
          updateMeteors(d);
          updateStars(d);
          updateControlRamps(d);
          acc -= d;
        }

        render();
        requestAnimationFrame(loop);
      }

      requestAnimationFrame(loop);
    });
  </script>
</body>
</html>
